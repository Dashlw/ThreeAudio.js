var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,c){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(c)},unbind:function(a,c){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(c),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger"],d=0;d<c.length;d++)a.prototype[c[d]]=MicroEvent.prototype[c[d]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(a){for(i in a)if(!window[i])throw"Error: ThreeAudio requires "+a[i];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(a){var c=document.getElementById(a);return c&&c.innerText||a};window._=window._||{};
_.each=_.each||function(a,c){if(a.forEach)return a.forEach(c);for(key in a)c(a[key],key,a)};_.extend=_.extend||function(a){_.each([].slice.call(arguments,1),function(c){for(var d in c)a[d]=c[d]});return a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger","on","emit"],d=0;d<c.length;d++)a.prototype[c[d]]=MicroEvent.prototype[c[d]]};ThreeAudio.toTexture=function(a){return ThreeRTT&&ThreeRTT.toTexture&&ThreeRTT.toTexture(a)||a};var \u03c0=Math.PI,\u03c4=2*\u03c0;ThreeAudio.Source=function(a){this.fftSize=a||1024;this.filters={};this.playing=false;this.init()};
ThreeAudio.Source.prototype={init:function(){var a=this.context=new webkitAudioContext;this.source=a.createBufferSource();this.analyser=a.createAnalyser();var c=this.analyser.fftSize=this.fftSize,d=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:500,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(f,e){var g=a.createBiquadFilter();g.key=e;g.type=f.type;g.frequency.value=f.frequency;g.Q.value=f.Q;g.analyser=a.createAnalyser();g.analyser.fftSize=
c;g.delayNode=a.createDelayNode();g.delayNode.delayTime.value=0;g.gainNode=a.createGainNode();g.gainNode.gain.value=f.gain;d[e]=g});this.delay=a.createDelayNode();this.delay.delayTime.value=this.fftSize*2/a.sampleRate;this.source.connect(this.analyser);this.analyser.connect(this.delay);this.delay.connect(a.destination);var j=this.source;_.each(d,function(a){j.connect(a.delayNode);a.delayNode.connect(a);a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.samples=this.analyser.frequencyBinCount;
this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(this.samples),mid:new Uint8Array(this.samples),treble:new Uint8Array(this.samples)}};this.levelDetect=new ThreeAudio.LevelDetect(this.data);this.beatDetect=new ThreeAudio.BeatDetect(this.data)},update:function(){var a=this.analyser,c=this.data;a.smoothingTimeConstant=0;a.getByteFrequencyData(c.freq);a.getByteTimeDomainData(c.time);_.each(this.filters,function(a){a.analyser.getByteTimeDomainData(c.filter[a.key])});
this.levelDetect.analyse();this.beatDetect.analyse();return this},size:function(){return this.analyser.frequencyBinCount},load:function(a,c){var d=this.context,j=this.source,f=this,e=new XMLHttpRequest;e.open("GET",a,true);e.responseType="arraybuffer";e.onload=function(){var a=d.createBuffer(e.response,false);j.buffer=a;j.loop=true;f.playing&&f._play();c&&c()};e.send();return this},play:function(){this.playing=true;this.source.buffer&&this._play();return this},stop:function(){this.playing=false;this.source.buffer&&
this._stop();return this},_play:function(){this.source.noteOn(0)},_stop:function(){this.source.noteOff(0)}};ThreeAudio.Source.prototype.start=ThreeAudio.Source.prototype.play;
ThreeAudio.Material=function(a,c,d,j,f,e){var e=e||[],f=_.extend(f||{},{audioIsBeat:{type:"f",value:0},audioWasBeat:{type:"f",value:0},audioLevels:{type:"fv1",value:[0,0,0,0]},audioLevelsSmooth:{type:"fv1",value:[0,0,0,0]},audioLevelsChange:{type:"fv1",value:[0,0,0,0]},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}}),g=0;_.each(a.get(),function(a,c){var d=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);
d.__webglInit=true;d.__webglTexture=a;f[c+"Data"]={type:"t",texture:d,value:g++}});_.each(j||[],function(a,c){f[c]={type:"t",value:g++,texture:ThreeAudio.toTexture(a)}});a.on("update",function(a){_.each(a,function(a,c){f[c].value=a})});return new THREE.ShaderMaterial({attributes:e,uniforms:f,vertexShader:ThreeAudio.getShader(c),fragmentShader:ThreeAudio.getShader(d)})};
ThreeAudio.Textures=function(a,c,d){this.renderer=a;this.source=c;this.textures={};this.history=d||128;this.timeIndex=0;this.data=c.data;this.init()};
ThreeAudio.Textures.prototype={init:function(){var a=this.renderer,c=a.getContext(),d=this.textures,j=this.data,f=this.history,e,g,k;_.each(["freq","time"],function(l){if(d[l]){c.deleteTexture(d[l]);a.info.memory.textures--}e=d[l]=c.createTexture();a.info.memory.textures++;c.bindTexture(c.TEXTURE_2D,e);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.LINEAR);g=j[l];k=new Uint8Array(g.length*f);if(l=="time")for(l=0;l<g.length*f;++l)k[l]=128;c.texImage2D(c.TEXTURE_2D,0,c.ALPHA,g.length,f,0,c.ALPHA,c.UNSIGNED_BYTE,k)})},update:function(){var a=this.renderer.getContext(),c=this.textures,d=this.source,j=this.history,f=this.timeIndex,e=d.data;d.update();_.each(["freq","time"],function(d){a.bindTexture(a.TEXTURE_2D,c[d]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,f,e[d].length,1,a.ALPHA,a.UNSIGNED_BYTE,
e[d])});this.emit("update",this.uniforms());this.timeIndex=(f+1)%j},get:function(){return this.textures},uniforms:function(){var a=this.data.levels,c=this.data.beat;return{audioIsBeat:c.is,audioWasBeat:c.was,audioLevels:a.direct,audioLevelsSmooth:a.smooth,audioLevelsChange:a.change,audioOffset:this.timeIndex/this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);
ThreeAudio.GridGeometry=function(a,c,d,j,f){var e=a.source,j=(j||e.samples)-1,f=Math.min(a.history,f||a.history)-1,g=f/a.history,k=0.5/(e.samples-1);offsetV=0.5/a.history;a=new THREE.PlaneGeometry(c,d,j,f);_.each(a.faceVertexUvs[0],function(a){_.each(a,function(a){a.u=a.u+k;a.v=1-a.v*g+offsetV})});return a};ThreeAudio.LevelDetect=function(a){this.data=a;this.levels=[[0,0,0,0]];this.smooth=[0,0,0,0];this.change=[0,0,0,0];a.levels={direct:this.levels[0],smooth:this.smooth,change:this.change}};
ThreeAudio.LevelDetect.prototype.analyse=function(){for(var a=this.data,c=this.levels,d=this.smooth,j=this.change,f=[0,0,0,0],e=[a.time,a.filter.bass,a.filter.mid,a.filter.treble],a=0;a<4;++a){var g=f,k=a,l;l=e[a];for(var p=l.length,h=0,n=0;n<p;++n)var m=(l[n]-128)/128,h=h+m*m;l=Math.sqrt(h/p);g[k]=l}c.unshift(f);c.length>7&&c.pop();e=[1,2,1];g=4;k=Math.min(c.length,e.length);for(l=0;l<4;++l){for(a=f=0;a<k;++a)f=f+(c[a]&&c[a][l]||0)*e[a];d[l]=f/g}e=[1,3,2,-2,-3,-1];g=6;Math.min(c.length,e.length);
for(l=0;l<4;++l){for(a=f=0;a<k;++a)f=f+(c[a]&&c[a][l]||0)*e[a];j[l]=j[l]+(f/g-j[l])*0.5}this.data.levels.direct=this.levels[0]};
ThreeAudio.BeatDetect=function(a){this.data=a;a.beat={permanence:0,confidence:0,missed:false,predicted:false,maybe:false,is:false,was:0,bpm:0};this.n=512;this.history=[[],[],[]];this.buffer=new Float32Array(this.n);this.spectrum=new Float32Array(this.n);this.fft=new FFT(this.n,44100);this.debouncePredict=this.debounceMaybe=this.measure=this.last=this.background=this.energy=this.sample=0;this.missed=3;this.decay=0;this.fMin=Math.floor(this.bpmToOffset(50));this.fMax=Math.ceil(this.bpmToOffset(400));
this.histogram={};this.histogramSorted=[];this.beat=null};
ThreeAudio.BeatDetect.prototype={initDebug:function(){this.c=document.createElement("canvas");this.c.width=512;this.c.height=340;this.c.style.position="absolute";this.c.style.zIndex=20;this.c.style.marginTop="100px";this.g=this.c.getContext("2d");this.i=0;this.t=document.createElement("div");this.t.width=512;this.t.height=200;this.t.style.background="rgba(0,0,0,.3)";this.t.style.color="#fff";this.t.style.position="absolute";this.t.style.zIndex=20;this.t.style.marginTop="340px";document.body.appendChild(this.c);
document.body.appendChild(this.t)},bpmToOffset:function(a){return this.n*a/3600},offsetToBPM:function(a){return 3600*a/this.n},analyse:function(){var a=this.data,c=a.levels,d=this.buffer,j=this.fft,f=this.n,e=this.history,g=this.histogram,k=this.histogramSorted,l=this,p=c.direct[0];for(e.unshift(p);e.length>f;)e.pop();d.set(e);j.forward(d);for(var h=j.real,e=j.real,j=j.imag,d=0;d<f;++d)h[d]=e[d]*e[d]+j[d]*j[d];e=0;for(d=2;d<f/8;++d)e=Math.max(e,h[d]);for(var j={},n=e/16,d=this.fMin+1;d<this.fMax;++d){var m=
h[d];if(m>n){var q=Math.max(h[d-1],h[d+1]);if(m>q){q=Math.min(h[d-1],h[d+1]);if(Math.abs(m-q)/m>0.5){var u=Math.sqrt(m/e);j[d]=u}}}}_.each(k,function(a){a.permanence=a.permanence*0.99;decay=Math.min(1,Math.log(1+a.permanence)/Math.log(10));a.strength=a.strength*decay;a.active=false});_.each(j,function(a,c){var c=+c,d=h[c-1],e=h[c+1],j=d+e-h[c]*2;b=(e-d)/2;fraction=-b/j;d=g[c];if(!d)if(d=g[c+1]){delete g[c+1];d.index=c;d.fraction=d.fraction+1;g[c]=d}else if(d=g[c-1]){delete g[c-1];d.index=c;d.fraction=
d.fraction-1;g[c]=d}else{d=g[c]={index:c,fraction:fraction,offset:0,strength:0,permanence:0,score:0,window:0};k.push(d)}d.fraction=d.fraction+(fraction-d.fraction)*0.1;d.strength=a;d.permanence=d.permanence+d.strength*0.01;d.offset=d.index+d.fraction;d.bpm=l.offsetToBPM(d.offset);d.window=f/d.offset;d.active=true});k.sort(function(a,c){return c.permanence-a.permanence});for(var r;(r=k[k.length-1])&&r.strength<0.01;){k.splice(k.length-1,1);delete g[r.index]}var v=this.fMin,s=0,t=0,o=null;_.each(k,
function(a){var c=0;if(!(a.offset<v)){var d,e=0,f=a.offset*1.5;_.each(k,function(c){if(c!=a&&!(c.offset<f)){var d=c.offset/a.offset,g=Math.max(0,1-Math.abs(d-Math.round(d))*8);u=c.strength*c.permanence*d;e=e+g*u}});d=e;d>c&&(c=d);c=c+a.strength*a.permanence;a.score=c;if(c>s){o=a;t=s;s=c}else c>t&&(t=c)}});if(o){o.score=s?1-t/s:0;o.confidence=Math.sqrt(o.score*o.permanence);if(this.beat)if(this.beat.confidence<o.confidence)this.beat=o;else{if(this.beat!=o)this.beat.confidence=this.beat.confidence*
0.95}else this.beat=o}m=c.direct[0];this.background=this.background+(m-this.background)*0.2;this.energy=this.energy+(m-this.energy)*0.4;r=(this.energy-this.background)/(1-this.background)*3;maybe=r*2-this.last-0.2;this.last=r;a.beat.missed=false;a.beat.maybe=false;a.beat.is=false;a.beat.predicted=false;if(this.beat){a.beat.confidence=this.beat.confidence;a.beat.permanence=this.beat.permanence;a.beat.bpm=this.beat.bpm}if(maybe>0.1&&this.debounceMaybe>10){this.debounceMaybe=0;if(!this.beat||this.beat.confidence<
0.3){this.measure=0;maybe>0.4?a.beat.is=true:a.beat.maybe=true}else if(this.beat){d=this.beat.window/2;d=(this.measure+d)%this.beat.window-d;if(Math.abs(d)<5){this.measure=this.measure-d;if(d<=0&&this.debouncePredict>10){a.beat.is=true;if(d==0)a.beat.predicted=true;this.debouncePredict=0;this.missed=Math.max(0,this.missed-3)}}else if(maybe>1-this.missed/10){this.measure=0;a.beat.is=true;this.debouncePredict=0;this.missed=Math.max(0,this.missed-3)}}}if(this.beat&&this.beat.confidence>0.3){d=this.debouncePredict>
10;if(e=this.measure>this.beat.window)this.measure=this.measure-this.beat.window;if(e&&d){if(maybe<0){this.missed=Math.min(10,this.missed+1);a.beat.missed=true}else this.missed=Math.max(0,this.missed-3);if(this.missed>4){e=false;a.beat.maybe=true;a.beat.predicted=true;this.debounceMaybe=this.debounceMaybe+Math.random()*10;this.debouncePredict=0}}if(e&&d){this.debouncePredict=0;a.beat.is=true;a.beat.predicted=true}}this.decay=this.decay+(+a.beat.is*3-this.decay)*0.33;a.beat.was=a.beat.was+(this.decay*
3-a.beat.was)*0.33;this.debounceMaybe++;this.debouncePredict++;this.measure++;this.debug(c.direct,p,r,maybe,h,j,k,a.beat)},debug:function(a,c,d,j,f,e,g,k){var l=this,e=this.n;if(this.g){var p=["<strong>"+Math.round(k.bpm*10)/10+" BPM ("+Math.round(100*k.confidence)+"%) "+Math.round(k.permanence*100)+"</strong>"];_.each(g,function(a){var c=Math.round(l.offsetToBPM(a.offset)*10)/10;p.push([c," bpm - ",Math.round(a.offset*10)/10," ",Math.round(a.fraction*100)/100," - %: ",Math.round(a.strength*100),
" - p: ",Math.round(a.permanence*100)].join(""))});this.t.innerHTML=p.join("<br>");var h=this.g;h.fillStyle="#000000";h.fillRect(0,140,512,100);for(var n=0,m=2;m<e/8;++m)n=Math.max(f[m],n);n=1/n;h.beginPath();h.moveTo(0,200);for(m=2;m<e/8;++m)h.lineTo((m-2)*8,240-f[m]*n*100);h.strokeStyle="#ffffff";h.stroke();_.each(g,function(a){h.fillStyle="rgba(255,"+(a.active?"255":"0")+",0,"+(a.strength*0.5+0.5)+")";h.fillRect((a.offset-2)*8,140,1,100)});var m=this.i,q=0,f=function(a){a=Math.round(Math.max(0,
Math.min(255,a*255)));h.fillStyle="rgb("+[a,a,a].join()+")";h.fillRect(m,q,1,20);q=q+20};f(a[0]);f(a[1]);f(a[2]);f(a[3]);if(k.is){h.fillStyle=k.missed?"rgba(255,0,0,.5)":k.predicted?"rgba(255,180,0,.5)":"rgba(30,180,0,.5)";h.fillRect(this.i,0,1,100)}a=Math.round(Math.max(0,Math.min(255,k.was*255)));h.fillStyle="rgb("+a+","+a+","+a+")";h.fillRect(412,240,100,100);if(k.maybe){h.fillStyle=k.predicted?"rgba(100,0,230,.5)":"rgba(0,180,255,.5)";h.fillRect(this.i,0,1,100)}if(c){c=Math.floor(Math.max(0,Math.min(1,
c))*255);h.fillStyle="rgba(0,"+c+","+c+",1)";h.fillRect(this.i,80,1,20)}if(d){d=Math.floor(Math.max(0,Math.min(1,d))*255);h.fillStyle="rgba("+d+",0,"+d+",1)";h.fillRect(this.i,100,1,20)}if(j){j=Math.floor(Math.max(0,Math.min(1,j))*255);h.fillStyle="rgba("+j+","+j+",0,1)";h.fillRect(this.i,120,1,20)}this.i=(m+1)%512}}};
