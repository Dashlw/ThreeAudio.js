var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,b){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(a){for(i in a)if(!window[i])throw"Error: ThreeAudio requires "+a[i];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};window._=window._||{};
_.each=_.each||function(a,b){if(a.forEach)return a.forEach(b);for(key in a)b(a[key],key,a)};_.extend=_.extend||function(a){_.each([].slice.call(arguments,1),function(b){for(var c in b)a[c]=b[c]});return a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};ThreeAudio.Source=function(a){this.fftSize=a||512;this.filters={};this.playing=false;this.init()};
ThreeAudio.Source.prototype={init:function(){var a=this.context=new webkitAudioContext;this.source=a.createBufferSource();this.analyser=a.createAnalyser();this.analyser.fftSize=this.fftSize;var b=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:400,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(c,e){var d=a.createBiquadFilter();d.key=e;d.type=c.type;d.frequency.value=c.frequency;d.Q.value=c.Q;d.analyser=a.createAnalyser();d.analyser.fftSize=512;
d.delayNode=a.createDelayNode();d.delayNode.delayTime.value=0;d.gainNode=a.createGainNode();d.gainNode.gain.value=c.gain;b[e]=d});this.delay=a.createDelayNode();this.delay.delayTime.value=this.fftSize*2/a.sampleRate;this.source.connect(this.analyser);this.analyser.connect(this.delay);this.delay.connect(a.destination);var c=this.source;_.each(b,function(a){c.connect(a.delayNode);a.delayNode.connect(a);a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.samples=this.analyser.frequencyBinCount;
this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(256),mid:new Uint8Array(256),treble:new Uint8Array(256)}}},update:function(){var a=this.analyser,b=this.data;a.smoothingTimeConstant=0;a.getByteFrequencyData(b.freq);a.getByteTimeDomainData(b.time);_.each(this.filters,function(a){a.analyser.getByteTimeDomainData(b.filter[a.key])});return this},size:function(){return this.analyser.frequencyBinCount},load:function(a,b){var c=this.context,f=this.source,
e=this,d=new XMLHttpRequest;d.open("GET",a,true);d.responseType="arraybuffer";d.onload=function(){var a=c.createBuffer(d.response,false);f.buffer=a;f.loop=true;e.playing&&e._play();b&&b()};d.send();return this},play:function(){this.playing=true;this.source.buffer&&this._play();return this},stop:function(){this.playing=false;this.source.buffer&&this._stop();return this},_play:function(){this.source.noteOn(0)},_stop:function(){this.source.noteOff(0)}};
ThreeAudio.Material=function(a,b,c,f,e,d){var d=d||[],e=_.extend(e||{},{audioLevels:{type:"fv1",value:0},audioLevelsSmooth:{type:"fv1",value:0},audioLevelsChange:{type:"fv1",value:0},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}}),g=0;_.each(a.get(),function(a,b){var c=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);c.__webglInit=true;c.__webglTexture=a;e[b+"Data"]={type:"t",texture:c,value:g++}});
_.each(f||[],function(a,b){e[b]={type:"t",value:g++,texture:a}});a.on("update",function(a){_.each(a,function(a,b){e[b].value=a})});return new THREE.ShaderMaterial({attributes:d,uniforms:e,vertexShader:ThreeAudio.getShader(b),fragmentShader:ThreeAudio.getShader(c)})};ThreeAudio.Textures=function(a,b,c){this.renderer=a;this.source=b;this.textures={};this.history=c||128;this.timeIndex=0;this.init()};
ThreeAudio.Textures.prototype={init:function(){var a=this.renderer,b=a.getContext(),c=this.textures,f=this.source,e=this.history,d,g,k;_.each(["freq","time"],function(h){if(c[h]){b.deleteTexture(c[h]);a.info.memory.textures--}d=c[h]=b.createTexture();a.info.memory.textures++;b.bindTexture(b.TEXTURE_2D,d);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MAG_FILTER,b.LINEAR);g=f.data[h];k=new Uint8Array(g.length*e);if(h=="time")for(h=0;h<g.length*e;++h)k[h]=128;b.texImage2D(b.TEXTURE_2D,0,b.ALPHA,g.length,e,0,b.ALPHA,b.UNSIGNED_BYTE,k)});this.audioLevels=[[1,0,0,0]];this.audioLevelsSmooth=[0,0,0,0];this.audioLevelsChange=[0,0,0,0]},update:function(){var a=this.renderer.getContext(),b=this.textures,c=this.source,f=this.history,e=this.timeIndex,d=c.data;levels=this.audioLevels;smooth=this.audioLevelsSmooth;change=this.audioLevelsChange;bins=
[0,0,0,0];c.update();for(var g=[d.time,d.filter.bass,d.filter.mid,d.filter.treble],c=0;c<4;++c){var k=bins,h=c,l;l=g[c];for(var j=l.length,m=0,n=0;n<j;++n)var o=(l[n]-128)/128,m=m+o*o;l=Math.sqrt(m/j);k[h]=l}levels.unshift(bins);levels.length>7&&levels.pop();k=[1,2,1];h=4;l=Math.min(levels.length,k.length);for(j=0;j<4;++j){for(c=g=0;c<l;++c)g=g+(levels[c]&&levels[c][j]||0)*k[c];smooth[j]=g/h}k=[1,3,2,-2,-3,-1];h=6;Math.min(levels.length,k.length);for(j=0;j<4;++j){for(c=g=0;c<l;++c)g=g+(levels[c]&&
levels[c][j]||0)*k[c];change[j]=change[j]+(g/h-change[j])*0.3}_.each(["freq","time"],function(c){a.bindTexture(a.TEXTURE_2D,b[c]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,e,d[c].length,1,a.ALPHA,a.UNSIGNED_BYTE,d[c])});this.emit("update",this.uniforms());this.timeIndex=(e+1)%f},get:function(){return this.textures},uniforms:function(){return{audioLevels:this.audioLevels[0],audioLevelsSmooth:this.audioLevelsSmooth,audioLevelsChange:this.audioLevelsChange,audioOffset:this.timeIndex/
this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);ThreeAudio.GridGeometry=function(a,b,c,f,e){var d=a.source,f=(f||d.samples)-1,e=Math.min(a.history,e||a.history)-1,g=e/a.history,k=0.5/(d.samples-1);offsetV=0.5/a.history;a=new THREE.PlaneGeometry(b,c,f,e);_.each(a.faceVertexUvs[0],function(a){_.each(a,function(a){a.u=a.u+k;a.v=1-a.v*g+offsetV})});return a};tQuery.World.register("audio",function(a){return tQuery.createAudioSource(this,a)});
tQuery.register("createAudioSource",function(a,b){var c=new ThreeAudio.Source(b);c.textures=function(b){return tQuery.createAudioTextures(a,this,b)};return c});tQuery.register("createAudioTextures",function(a,b,c){var f=new ThreeAudio.Textures(a.tRenderer(),b,c);f.material=function(a,b,c,f,h){return tQuery.createAudioMaterial(this,a,b,c,f,h)};a.loop().hookPreRender(function(){f.update()});return f});
tQuery.register("createAudioMaterial",function(a,b,c,f,e,d){b=new ThreeAudio.Material(a,b,c,f,e,d);b.grid=function(b,c,d,e){return tQuery.createAudioGrid(a,b,c,d,e,this)};return b});tQuery.register("createAudioGrid",function(a){var b=ThreeAudio.GridGeometry,c=[a,1,1,0,0];for(i in c)arguments[i]=arguments[i]||c[i];return this._createMesh(b,c,arguments)});
