var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,c){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(c)},unbind:function(a,c){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(c),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger"],e=0;e<c.length;e++)a.prototype[c[e]]=MicroEvent.prototype[c[e]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);(function(a){for(i in a)if(!window[i])throw"Error: ThreeAudio requires "+a[i];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(a){var c=document.getElementById(a);return c&&c.innerText||a};window._=window._||{};
_.each=_.each||function(a,c){if(a.forEach)return a.forEach(c);for(key in a)c(a[key],key,a)};_.extend=_.extend||function(a){_.each([].slice.call(arguments,1),function(c){for(var e in c)a[e]=c[e]});return a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger","on","emit"],e=0;e<c.length;e++)a.prototype[c[e]]=MicroEvent.prototype[c[e]]};ThreeAudio.toTexture=function(a){return ThreeRTT&&ThreeRTT.toTexture&&ThreeRTT.toTexture(a)||a};var \u03c0=Math.PI,\u03c4=2*\u03c0;ThreeAudio.Source=function(a){this.fftSize=a||1024;this.filters={};this.playing=false;this.init()};
ThreeAudio.Source.prototype={init:function(){var a=this.context=new webkitAudioContext;this.source=a.createBufferSource();this.analyser=a.createAnalyser();var c=this.analyser.fftSize=this.fftSize,e=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:500,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(d,f){var g=a.createBiquadFilter();g.key=f;g.type=d.type;g.frequency.value=d.frequency;g.Q.value=d.Q;g.analyser=a.createAnalyser();g.analyser.fftSize=
c;g.delayNode=a.createDelayNode();g.delayNode.delayTime.value=0;g.gainNode=a.createGainNode();g.gainNode.gain.value=d.gain;e[f]=g});this.delay=a.createDelayNode();this.delay.delayTime.value=this.fftSize*2/a.sampleRate;this.source.connect(this.analyser);this.analyser.connect(this.delay);this.delay.connect(a.destination);var d=this.source;_.each(e,function(a){d.connect(a.delayNode);a.delayNode.connect(a);a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.samples=this.analyser.frequencyBinCount;
this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(this.samples),mid:new Uint8Array(this.samples),treble:new Uint8Array(this.samples)}};this.levelDetect=new ThreeAudio.LevelDetect(this.data);this.beatDetect=new ThreeAudio.BeatDetect(this.data)},update:function(){var a=this.analyser,c=this.data;a.smoothingTimeConstant=0;a.getByteFrequencyData(c.freq);a.getByteTimeDomainData(c.time);_.each(this.filters,function(a){a.analyser.getByteTimeDomainData(c.filter[a.key])});
this.levelDetect.analyse();this.beatDetect.analyse();return this},size:function(){return this.analyser.frequencyBinCount},load:function(a,c){var e=this.context,d=this.source,h=this,f=new XMLHttpRequest;f.open("GET",a,true);f.responseType="arraybuffer";f.onload=function(){var a=e.createBuffer(f.response,false);d.buffer=a;d.loop=true;h.playing&&h._play();c&&c()};f.send();return this},play:function(){this.playing=true;this.source.buffer&&this._play();return this},stop:function(){this.playing=false;this.source.buffer&&
this._stop();return this},_play:function(){this.source.noteOn(0)},_stop:function(){this.source.noteOff(0)}};ThreeAudio.Source.prototype.start=ThreeAudio.Source.prototype.play;
ThreeAudio.Material=function(a,c,e,d,h,f){var f=f||[],h=_.extend(h||{},{audioIsBeat:{type:"f",value:0},audioWasBeat:{type:"f",value:0},audioLevels:{type:"fv1",value:[0,0,0,0]},audioLevelsSmooth:{type:"fv1",value:[0,0,0,0]},audioLevelsChange:{type:"fv1",value:[0,0,0,0]},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}}),g=0;_.each(a.get(),function(a,c){var d=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);
d.__webglInit=true;d.__webglTexture=a;h[c+"Data"]={type:"t",texture:d,value:g++}});_.each(d||[],function(a,c){h[c]={type:"t",value:g++,texture:ThreeAudio.toTexture(a)}});a.on("update",function(a){_.each(a,function(a,c){h[c].value=a})});return new THREE.ShaderMaterial({attributes:f,uniforms:h,vertexShader:ThreeAudio.getShader(c),fragmentShader:ThreeAudio.getShader(e)})};
ThreeAudio.Textures=function(a,c,e){this.renderer=a;this.source=c;this.textures={};this.history=e||128;this.timeIndex=0;this.data=c.data;this.init()};
ThreeAudio.Textures.prototype={init:function(){var a=this.renderer,c=a.getContext(),e=this.textures,d=this.data,h=this.history,f,g,k;_.each(["freq","time"],function(m){if(e[m]){c.deleteTexture(e[m]);a.info.memory.textures--}f=e[m]=c.createTexture();a.info.memory.textures++;c.bindTexture(c.TEXTURE_2D,f);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.LINEAR);g=d[m];k=new Uint8Array(g.length*h);if(m=="time")for(m=0;m<g.length*h;++m)k[m]=128;c.texImage2D(c.TEXTURE_2D,0,c.ALPHA,g.length,h,0,c.ALPHA,c.UNSIGNED_BYTE,k)})},update:function(){var a=this.renderer.getContext(),c=this.textures,e=this.source,d=this.history,h=this.timeIndex,f=e.data;e.update();_.each(["freq","time"],function(d){a.bindTexture(a.TEXTURE_2D,c[d]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,h,f[d].length,1,a.ALPHA,a.UNSIGNED_BYTE,
f[d])});this.emit("update",this.uniforms());this.timeIndex=(h+1)%d},get:function(){return this.textures},uniforms:function(){var a=this.data.levels,c=this.data.beat;return{audioIsBeat:c.is,audioWasBeat:c.was,audioLevels:a.direct,audioLevelsSmooth:a.smooth,audioLevelsChange:a.change,audioOffset:this.timeIndex/this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);
ThreeAudio.GridGeometry=function(a,c,e,d,h){var f=a.source,d=(d||f.samples)-1,h=Math.min(a.history,h||a.history)-1,g=h/a.history,k=0.5/(f.samples-1);offsetV=0.5/a.history;a=new THREE.PlaneGeometry(c,e,d,h);_.each(a.faceVertexUvs[0],function(a){_.each(a,function(a){a.u=a.u+k;a.v=1-a.v*g+offsetV})});return a};ThreeAudio.LevelDetect=function(a){this.data=a;this.levels=[[0,0,0,0]];this.smooth=[0,0,0,0];this.change=[0,0,0,0];a.levels={direct:this.levels[0],smooth:this.smooth,change:this.change}};
ThreeAudio.LevelDetect.prototype.analyse=function(){for(var a=this.data,c=this.levels,e=this.smooth,d=this.change,h=[0,0,0,0],f=[a.time,a.filter.bass,a.filter.mid,a.filter.treble],a=0;a<4;++a){var g=h,k=a,m;m=f[a];for(var j=m.length,p=0,u=0;u<j;++u)var s=(m[u]-128)/128,p=p+s*s;m=Math.sqrt(p/j);g[k]=m}c.unshift(h);c.length>7&&c.pop();f=[1,2,1];g=4;k=Math.min(c.length,f.length);for(m=0;m<4;++m){for(a=h=0;a<k;++a)h=h+(c[a]&&c[a][m]||0)*f[a];e[m]=h/g}f=[1,3,2,-2,-3,-1];g=6;Math.min(c.length,f.length);
for(m=0;m<4;++m){for(a=h=0;a<k;++a)h=h+(c[a]&&c[a][m]||0)*f[a];d[m]=d[m]+(h/g-d[m])*0.5}this.data.levels.direct=this.levels[0]};var __taDebug=!1;
ThreeAudio.BeatDetect=function(a){this.data=a;a.beat={permanence:0,confidence:0,missed:false,predicted:false,maybe:false,is:false,was:0,stddev:0,bpm:0};__taDebug&&this.initDebug();this.n=512;this.history=[[],[],[]];this.buffer=new Float32Array(this.n);this.spectrum=null;this.fft=new FFT(this.n,44100);this.decay=this.debouncePredict=this.debounceMaybe=this.maxMaybe=this.maybe=this.measure=this.signal=this.energy=this.background=this.sample=0;this.intervals=[];this.jitter=this.stddev=this.mean=0;this.missed=
3;this.found=0;this.predicted=false;this.green=0;this.fMin=Math.floor(this.bpmToOffset(50));this.fMax=Math.ceil(this.bpmToOffset(400));this.histogram={};this.histogramSorted=[];this.beat=null;this.frames=0};
ThreeAudio.BeatDetect.prototype={initDebug:function(){this.c=document.createElement("canvas");this.c.width=512;this.c.height=340;this.c.style.position="absolute";this.c.style.zIndex=20;this.c.style.marginTop="100px";this.g=this.c.getContext("2d");this.i=0;this.t=document.createElement("div");this.t.width=256;this.t.height=200;this.t.style.background="rgba(0,0,0,.3)";this.t.style.color="#fff";this.t.style.position="absolute";this.t.style.zIndex=20;this.t.style.marginTop="340px";document.body.appendChild(this.c);
document.body.appendChild(this.t)},bpmToOffset:function(a){return this.n*a/3600},offsetToBPM:function(a){return 3600*a/this.n},analyse:function(){var a=this.data,c=a.levels,e=this.buffer,d=this.fft,h=this.n,f=this.history,g=this.histogram,k=this.histogramSorted,m=this;a.beat.missed=false;a.beat.maybe=false;a.beat.is=false;a.beat.predicted=false;a.beat.locked=false;a.beat.adjusted=false;if(this.beat){a.beat.confidence=this.beat.confidence;a.beat.permanence=this.beat.permanence;a.beat.bpm=this.beat.bpm}var j=
c.direct[0];this.background=this.background+(j-this.background)*0.2;this.energy=this.energy+(j-this.energy)*0.4;this.signal=j=(this.energy-this.background)/(1-this.background)*3;c=this.maybe;maybe=j*2-this.signal;this.maxMaybe=Math.max(this.maxMaybe*0.99,maybe);this.maybe=maybe=maybe/Math.max(0.2,this.maxMaybe)-0.7;this.sample=j;for(f.unshift(j);f.length>h;)f.pop();e.set(f);d.forward(e);for(var p=this.spectrum=d.real,j=d.real,e=d.imag,d=0;d<h;++d)p[d]=j[d]*j[d]+e[d]*e[d];e=0;for(d=2;d<h/8;++d)e=Math.max(e,
p[d]);for(var f={},u=e/16,d=this.fMin+1;d<this.fMax;++d){j=p[d];if(j>u){var s=Math.max(p[d-1],p[d+1]);if(j>s){s=Math.min(p[d-1],p[d+1]);if(Math.abs(j-s)/j>0.5){var n=Math.sqrt(j/e);f[d]=n}}}}_.each(k,function(a){a.permanence=a.permanence*0.99;decay=Math.min(1,Math.log(1+a.permanence)/Math.log(10));a.strength=a.strength*decay;a.active=false});_.each(f,function(a,c){var c=+c,d=p[c-1],e=p[c+1],f=d+e-p[c]*2;b=(e-d)/2;fraction=-b/f;d=g[c];if(!d)if(d=g[c+1]){delete g[c+1];d.index=c;d.fraction=d.fraction+
1;g[c]=d}else if(d=g[c-1]){delete g[c-1];d.index=c;d.fraction=d.fraction-1;g[c]=d}else{d=g[c]={index:c,fraction:fraction,offset:0,strength:0,permanence:0,score:0,window:0};k.push(d)}d.fraction=d.fraction+(fraction-d.fraction)*0.1;d.strength=a;d.permanence=d.permanence+d.strength*0.01;d.offset=d.index+d.fraction;d.bpm=m.offsetToBPM(d.offset);d.window=h/d.offset;d.active=true});k.sort(function(a,c){return c.permanence-a.permanence});for(var o;(o=k[k.length-1])&&o.strength<0.01;){k.splice(k.length-1,
1);delete g[o.index]}var q=this.fMin,t=0,v=0,r=null;_.each(k,function(a){var c=0;if(!(a.offset<q)){var d,e=0,g=a.offset*1.5;_.each(k,function(c){if(c!=a&&!(c.offset<g)){var d=c.offset/a.offset,f=Math.max(0,1-Math.abs(d-Math.round(d))*4);n=c.strength*c.permanence*d;e=e+f*n}});d=e;d>c&&(c=d);c=c+a.strength*a.permanence;a.score=c;if(c>t){r=a;v=t;t=c}else c>v&&(v=c)}});if(r){r.score=t?1-v/t:0;r.confidence=Math.min(1,r.score+r.permanence);if(this.beat)if(this.beat.confidence<r.confidence)this.beat=r;else{if(this.beat!=
r)this.beat.confidence=this.beat.confidence*0.95}else this.beat=r;if(this.beat.bpm>240){this.beat.bpm=this.beat.bpm/2;this.beat.window=this.beat.window*2}}o=this.measure;d=0;if(this.beat){d=this.beat.window;if(this.mean&&this.stddev<2){d=this.mean;a.beat.locked=true;a.beat.bpm=this.offsetToBPM(this.n/d)}}if(maybe>0&&c<=0&&this.debounceMaybe>5){this.debounceMaybe=0;if(!this.beat||!a.beat.locked&&this.beat.confidence<0.3){this.measure=0;a.beat.is=true;a.beat.maybe=true}else if(this.beat){c=this.beat.window/
2;c=(this.measure+c)%d-c;j=this.jitter&&Math.max(3,Math.min(this.jitter+1,10))||10;if(Math.abs(c)<j){this.measure=0;if(c<=1&&this.debouncePredict>5||!this.predicted){a.beat.is=true;if(c>=0)a.beat.predicted=true;this.debouncePredict=0;this.found=Math.min(10,this.found+1);a.beat.adjusted=true}else{a.beat.maybe=true;this.intervals[0]=this.intervals[0]+c;this.found=Math.min(10,this.found+1);this.missed=Math.max(0,this.missed-1)}this.found=Math.min(10,this.found+1);this.missed=Math.max(0,this.missed-3)}else if(maybe>
1+this.found*0.2+0.5/this.stddev-this.missed/10||this.found==0||this.missed>4){this.measure=0;a.beat.is=true;this.debouncePredict=0;this.found=Math.min(10,this.found+1);this.missed=Math.max(0,this.missed-3)}else a.beat.maybe=true}}if(this.beat&&this.beat.confidence>0.3){c=this.debouncePredict>5;if(j=this.measure>=d)this.measure=this.measure-d;if(j&&c){if(maybe<0){this.found=Math.max(0,this.found-1);this.missed=Math.min(10,this.missed+1);a.beat.missed=true;a.beat.predicted=true}else{this.found=Math.min(10,
this.found+1);this.missed=Math.max(0,this.missed-3)}if(this.found<1){j=false;a.beat.maybe=true;a.beat.predicted=true;this.debouncePredict=0}else if(this.missed>4){j=false;a.beat.maybe=true;a.beat.predicted=true;this.measure=this.measure+Math.random()*5;this.debounceMaybe=this.debounceMaybe+Math.random()*5;this.debouncePredict=0}this.predicted=j}if(j&&c){this.debouncePredict=0;a.beat.is=true;a.beat.predicted=true}}c=0;if(this.missed>3)this.green=0;else if(a.beat.is||a.beat.adjusted){this.green++&&
(c=this.frames-this.lastGreen);this.lastGreen=this.frames}if(c){c=this.intervals;c.unshift(o);c.length>12&&c.pop();c=c.slice();c.sort();c=c.slice(2,10);if(c.length>6){j=o=0;l=c.length;for(d=0;d<l;++d){o=o+c[d];j=j+c[d]*c[d]}o=o/l;j=j/l;this.mean=o;this.stddev=Math.sqrt(j-o*o)}}this.jitter=(this.stddev+this.missed*0.5)*(1+this.missed);this.decay=this.decay+(+a.beat.is*2.5-this.decay)*0.4;a.beat.was=a.beat.was+(this.decay*2.5-a.beat.was)*0.4;this.debounceMaybe++;this.debouncePredict++;this.measure++;
this.frames++;__taDebug&&this.debug()},debug:function(){function a(a){a=Math.round(Math.max(0,Math.min(255,a*255)));n.fillStyle="rgb("+[a,a,a].join()+")";n.fillRect(q,t,1,20);t=t+20}var c=this.data.levels.direct,e=this.sample,d=this.signal,h=this.maybe,f=this.spectrum,g=this.histogram,k=this.data.beat,m=this,j=this.n;if(this.beat){var p=this.beat,u=p.offset*1.5;_.each(g,function(a){var c=a==p?1:0;if(a.offset>u){c=a.offset/p.offset;c=Math.max(0,1-Math.abs(c-Math.round(c))*4)}a.match=c})}var s=["<strong><span"+
(k.locked?' style="color: rgb(180,255,0)"':"")+">"+Math.round(k.bpm*10)/10+" BPM </span> ("+Math.round(100*k.confidence)+"%) P:"+Math.round(k.permanence*100)+" \u00b5 = "+Math.round(this.mean*10)/10+" \u03c3 = "+Math.round(this.stddev*100)/100+"</strong> "+this.found+"f "+this.missed+"m"];_.each(g,function(a){var c=Math.round(m.offsetToBPM(a.offset)*10)/10;s.push([c," bpm - ",Math.round(a.strength*100),"% P: ",Math.round(a.permanence*100)].join(""))});this.t.innerHTML=s.join("<br>");var n=this.g;
n.fillStyle="#000000";n.fillRect(0,140,512,100);for(var o=0,q=2;q<j/8;++q)o=Math.max(f[q],o);o=1/o;n.beginPath();n.moveTo(0,200);for(q=2;q<j/8;++q)n.lineTo((q-2)*8,240-f[q]*o*100);n.strokeStyle="#ffffff";n.stroke();_.each(g,function(a){var c=a.strength*0.75+0.25,d=a.active?[Math.round(255-195*a.match),Math.round(180+40*a.match),0].join():"255,10,10";n.fillStyle="rgba("+d+","+c+")";n.fillRect((a.offset-2)*8,140,1,100)});var q=this.i,t=0;a(c[1]);a(c[2]);a(c[3]);a(0);if(k.is){n.fillStyle=k.missed?"rgba(255,0,0,.5)":
k.maybe?"rgba(0,180,255,.75)":k.predicted?"rgba(255,180,0,.75)":"rgba(60,220,0,.75)";n.fillRect(this.i,0,2,100)}c=Math.round(Math.max(0,Math.min(255,k.was*255)));n.fillStyle="rgb("+c+","+c+","+c+")";n.fillRect(412,240,100,100);if(k.maybe&&!k.is){n.fillStyle="rgba(64,64,64,.75)";n.fillRect(this.i,0,2,100)}e=Math.floor(Math.max(0,Math.min(1,e+0.5))*255);n.fillStyle="rgba("+Math.round(e*0.7)+","+Math.round(e*0.8)+","+e+",1)";n.fillRect(this.i,80,1,20);d=Math.floor(Math.max(0,Math.min(1,d*2))*255);n.fillStyle=
"rgba("+d+","+Math.round(d*0.8)+","+Math.round(d*0.5)+",1)";n.fillRect(this.i,100,1,20);h=k.is||k.maybe?Math.floor(Math.max(0,Math.min(1,h+0.5))*255):0;n.fillStyle="rgba("+Math.round(h*0.9)+","+h+","+Math.round(h*0.5)+",1)";n.fillRect(this.i,120,1,20);this.i=(q+1)%512}};tQuery.World.register("audio",function(a){return tQuery.createAudioSource(this,a)});
tQuery.register("createAudioSource",function(a,c){var e=new ThreeAudio.Source(c);e.textures=function(c){return tQuery.createAudioTextures(a,this,c)};return e});tQuery.register("createAudioTextures",function(a,c,e){var d=new ThreeAudio.Textures(a.tRenderer(),c,e);d.material=function(a,c,d,e,m){return tQuery.createAudioMaterial(this,a,c,d,e,m)};a.loop().hookPreRender(function(){d.update()});return d});
tQuery.register("createAudioMaterial",function(a,c,e,d,h,f){c=new ThreeAudio.Material(a,c,e,d,h,f);c.grid=function(c,d,e,f){return tQuery.createAudioGrid(a,c,d,e,f,this)};return c});tQuery.register("createAudioGrid",function(a,c,e,d,h,f){var g=[a,1,1,0,0];for(i in g)arguments[i]=arguments[i]||g[i];g=new ThreeAudio.GridGeometry(a,c||1,e||1,d,h);f=f||tQuery.defaultObject3DMaterial;g=new THREE.Mesh(g,f);g.doubleSided=true;g.frustumCulled=false;return tQuery(g)});
